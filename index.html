<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PLM ECR0007 — TFR & Drawings Tracker</title>
<style>
  :root {
    --bg: #0b1220;
    --panel: #121a2b;
    --panel2: #0f1726;
    --text: #e9eefc;
    --muted: #a8b3d6;
    --accent: #1581a6;
    --accent2: #0b3b6e;
    --danger: #ff6b6b;
    --warn: #ffd166;
    --ok: #6ee7b7;
    --border: rgba(233,238,252,.12);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: var(--sans);
    background: radial-gradient(1200px 600px at 20% 0%, rgba(21,129,166,.25), transparent 60%),
                radial-gradient(900px 500px at 90% 10%, rgba(11,59,110,.25), transparent 55%),
                var(--bg);
    color: var(--text);
  }
  header {
    position: sticky; top: 0; z-index: 10;
    backdrop-filter: blur(10px);
    background: rgba(11,18,32,.7);
    border-bottom: 1px solid var(--border);
  }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 18px 18px 26px; }
  .topbar {
    display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
  }
  h1 {
    margin:0; font-size: 18px; letter-spacing:.2px;
  }
  .sub {
    margin-top:6px; color: var(--muted); font-size: 12px;
  }
  .pill {
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 10px; border: 1px solid var(--border);
    border-radius: 999px; background: rgba(18,26,43,.65);
    box-shadow: var(--shadow);
  }
  .pill b { font-weight: 600; }
  .tabs {
    display:flex; gap:8px; margin-top: 14px; flex-wrap: wrap;
  }
  .tab {
    cursor:pointer;
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(18,26,43,.65);
    color: var(--text);
    font-size: 13px;
    user-select:none;
  }
  .tab.active {
    background: linear-gradient(90deg, rgba(21,129,166,.35), rgba(11,59,110,.35));
    border-color: rgba(21,129,166,.55);
  }
  .grid {
    display:grid;
    grid-template-columns: 1.6fr 1fr;
    gap: 14px;
    margin-top: 14px;
  }
  @media (max-width: 980px) {
    .grid { grid-template-columns: 1fr; }
  }
  .card {
    background: rgba(18,26,43,.72);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .card .hd {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(11,59,110,.35), transparent);
    display:flex; align-items:center; justify-content:space-between; gap: 10px;
  }
  .card .bd { padding: 12px 14px; }
  .hd .title { font-size: 13px; font-weight: 650; }
  .hd .hint { font-size: 12px; color: var(--muted); }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th, td {
    padding: 10px 10px;
    border-bottom: 1px solid rgba(233,238,252,.08);
    vertical-align: top;
  }
  th {
    text-align:left;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }
  tr:hover td { background: rgba(255,255,255,.02); }
  .btnrow { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  button {
    cursor:pointer;
    border: 1px solid var(--border);
    background: rgba(15,23,38,.9);
    color: var(--text);
    padding: 9px 11px;
    border-radius: 10px;
    font-size: 13px;
  }
  button.primary {
    border-color: rgba(21,129,166,.6);
    background: rgba(21,129,166,.18);
  }
  button.danger {
    border-color: rgba(255,107,107,.6);
    background: rgba(255,107,107,.12);
  }
  button:active { transform: translateY(1px); }
  .muted { color: var(--muted); }
  .kpi {
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media (max-width: 700px) {
    .kpi { grid-template-columns: 1fr; }
  }
  .k {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(15,23,38,.75);
  }
  .k .n { font-size: 18px; font-weight: 750; }
  .k .l { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .progress {
    height: 9px;
    background: rgba(233,238,252,.10);
    border-radius: 999px;
    overflow:hidden;
    border: 1px solid rgba(233,238,252,.08);
  }
  .progress > div {
    height:100%;
    width:0%;
    background: linear-gradient(90deg, rgba(21,129,166,.95), rgba(11,59,110,.95));
  }
  .chip {
    display:inline-flex; align-items:center; gap:6px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(233,238,252,.12);
    font-size: 12px;
    white-space: nowrap;
  }
  .chip.ok { border-color: rgba(110,231,183,.45); background: rgba(110,231,183,.10); }
  .chip.warn { border-color: rgba(255,209,102,.45); background: rgba(255,209,102,.10); }
  .chip.bad { border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.10); }
  .chip.neutral { border-color: rgba(168,179,214,.35); background: rgba(168,179,214,.08); }
  .form {
    display:grid; gap:10px;
  }
  .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
  @media (max-width: 700px) {
    .row2, .row3 { grid-template-columns: 1fr; }
  }
  label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
  input, select, textarea {
    width: 100%;
    padding: 10px 10px;
    border-radius: 10px;
    border: 1px solid rgba(233,238,252,.14);
    background: rgba(10,15,26,.6);
    color: var(--text);
    outline: none;
    font-family: var(--sans);
    font-size: 13px;
  }
  textarea { min-height: 88px; resize: vertical; }
  .mono { font-family: var(--mono); }
  .split {
    display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; flex-wrap:wrap;
  }
  .link {
    color: #9adfff;
    text-decoration: none;
  }
  .link:hover { text-decoration: underline; }
  .footer-note {
    margin-top: 14px;
    color: var(--muted);
    font-size: 12px;
    line-height: 1.45;
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>PLM ECR0007 — Drawings & TFR Tracker</h1>
        <div class="sub">Single-file HTML. Saves locally in your browser (no internet, no SharePoint drama).</div>
      </div>
      <div class="pill">
        <span class="muted">Team:</span>
        <b id="teamCount">0</b>
        <span class="muted">people</span>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>
  </div>
</header>

<main class="wrap">
  <section id="view_master" class="view">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Master Sheet</div>
            <div class="hint">Sites + deliverable status. Click a site row to open full details.</div>
          </div>
          <div class="btnrow">
            <button class="primary" id="btnNewTask">+ New Task</button>
            <button id="btnExport">Export JSON</button>
            <button id="btnImport">Import JSON</button>
          </div>
        </div>
        <div class="bd">
          <div class="kpi" style="margin-bottom:12px">
            <div class="k"><div class="n" id="kpiSites">0</div><div class="l">Sites</div></div>
            <div class="k"><div class="n" id="kpiTasksOpen">0</div><div class="l">Open Tasks</div></div>
            <div class="k"><div class="n" id="kpiDueSoon">0</div><div class="l">Due in ≤ 7 days</div></div>
          </div>

          <table id="sitesTable">
            <thead>
              <tr>
                <th style="width:28%">Site</th>
                <th style="width:12%">CDRL</th>
                <th>Deliverables</th>
                <th style="width:18%">Overall</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="footer-note">
            Overall progress is calculated from deliverable status and task completion.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <div class="title">My Work Queue</div>
            <div class="hint">Filter by owner. Quick view of what’s open.</div>
          </div>
        </div>
        <div class="bd">
          <div class="row2" style="margin-bottom:10px">
            <div>
              <label>Owner</label>
              <select id="filterOwner"></select>
            </div>
            <div>
              <label>Status</label>
              <select id="filterStatus">
                <option value="__open__">Open (Not Started / In Progress / Blocked)</option>
                <option value="__all__">All</option>
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Blocked">Blocked</option>
                <option value="Done">Done</option>
              </select>
            </div>
          </div>
          <table id="queueTable">
            <thead>
              <tr>
                <th>Task</th>
                <th style="width:18%">Owner</th>
                <th style="width:18%">Due</th>
                <th style="width:14%">Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="footer-note">
            This view shows tasks based on current status and assignments.
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view_site" class="view" style="display:none">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title" id="siteTitle">Site</div>
          <div class="hint" id="siteHint"></div>
        </div>
        <div class="btnrow">
          <button id="btnBack">← Back</button>
          <button class="primary" id="btnAddSiteTask">+ Task for this Site</button>
        </div>
      </div>
      <div class="bd">
        <div class="row3" style="margin-bottom:12px">
          <div>
            <label>Rooms (total)</label>
            <input id="siteRooms" placeholder="e.g., 25" />
          </div>
          <div>
            <label>Site Due Date</label>
            <input id="siteDue" type="date" />
          </div>
          <div>
            <label>CDRL</label>
            <input id="siteCdrl" disabled />
          </div>
        </div>

        <div class="row2" style="margin-bottom:12px">
          <div>
            <label>Site Notes</label>
            <textarea id="siteNotes" placeholder="Notes, constraints, blockers, access issues, NAVFAC contacts, etc."></textarea>
          </div>
          <div>
            <label>Deliverables Status</label>
            <div id="deliverableGrid" class="form"></div>
          </div>
        </div>

        <div class="card" style="background: rgba(15,23,38,.55); border-radius: 12px;">
          <div class="hd" style="border-radius:12px 12px 0 0;">
            <div>
              <div class="title">Tasks for this Site</div>
              <div class="hint">Rooms / drawings / narrative / QC / submittal — whatever needs doing.</div>
            </div>
          </div>
          <div class="bd">
            <table id="siteTasksTable">
              <thead>
                <tr>
                  <th>Task</th>
                  <th style="width:14%">Owner</th>
                  <th style="width:14%">Type</th>
                  <th style="width:14%">Room</th>
                  <th style="width:14%">Due</th>
                  <th style="width:12%">Status</th>
                  <th style="width:10%"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="footer-note">Click “Edit” to update a task or “Delete” to remove it.</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <section id="view_tasks" class="view" style="display:none">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title">All Tasks</div>
          <div class="hint">Search, sort, and keep everyone honest.</div>
        </div>
        <div class="btnrow">
          <button class="primary" id="btnNewTask2">+ New Task</button>
          <button class="danger" id="btnNukeDone">Delete Done Tasks</button>
        </div>
      </div>
      <div class="bd">
        <div class="row3" style="margin-bottom:10px">
          <div>
            <label>Search</label>
            <input id="taskSearch" placeholder="type to filter…" />
          </div>
          <div>
            <label>Owner</label>
            <select id="taskOwnerFilter"></select>
          </div>
          <div>
            <label>Site</label>
            <select id="taskSiteFilter"></select>
          </div>
        </div>

        <table id="tasksTable">
          <thead>
            <tr>
              <th>Task</th>
              <th style="width:14%">Site</th>
              <th style="width:14%">Owner</th>
              <th style="width:14%">Type</th>
              <th style="width:12%">Room</th>
              <th style="width:12%">Due</th>
              <th style="width:12%">Status</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="footer-note">
          All tasks and fields are editable as project requirements evolve.
        </div>
      </div>
    </div>
  </section>

  <section id="view_settings" class="view" style="display:none">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title">Settings</div>
          <div class="hint">People list + data reset.</div>
        </div>
        <div class="btnrow">
          <button id="btnReset">Reset to Default</button>
        </div>
      </div>
      <div class="bd">
        <div class="row2">
          <div>
            <label>People (one per line)</label>
            <textarea id="peopleBox" class="mono" spellcheck="false"></textarea>
          </div>
          <div>
            <label>Data Storage</label>
            <div class="muted" style="line-height:1.6">
              <div><span class="mono">localStorage</span> key: <span class="mono" id="lsKey"></span></div>
              <div style="margin-top:10px">
                <button class="primary" id="btnSavePeople">Save People</button>
              </div>
              <div class="footer-note" style="margin-top:12px">
                This file stores data in your browser only. If you clear browser storage, it’s gone — like an un-synced SharePoint upload.
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top:14px" class="footer-note">
          Seeded site list and CDRL mapping align to the ECR0007 SOW deliverables table (A001–A014).
        </div>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,.55); z-index:50;">
    <div style="max-width: 820px; margin: 6vh auto; padding: 0 14px;">
      <div class="card">
        <div class="hd">
          <div>
            <div class="title" id="modalTitle">New Task</div>
            <div class="hint" id="modalHint">Add / edit a task.</div>
          </div>
          <div class="btnrow">
            <button id="btnClose">Close</button>
            <button class="primary" id="btnSave">Save</button>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div>
              <label>Task Name</label>
              <input id="t_name" placeholder="e.g., Gulfport — Planned drawings (Bldg 360 / Rm 100–105)" />
            </div>
            <div class="row3">
              <div>
                <label>Site</label>
                <select id="t_site"></select>
              </div>
              <div>
                <label>Owner</label>
                <select id="t_owner"></select>
              </div>
              <div>
                <label>Type</label>
                <select id="t_type">
                  <option value="Drawings – Existing">Drawings – Existing</option>
                  <option value="Drawings – Planned">Drawings – Planned</option>
                  <option value="TFR Narrative / Analysis">TFR Narrative / Analysis</option>
                  <option value="QC / Internal Review">QC / Internal Review</option>
                  <option value="Submitted">Submitted</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="row3">
              <div>
                <label>Room / Bldg</label>
                <input id="t_room" placeholder="e.g., Bldg 360 Rm 100" />
              </div>
              <div>
                <label>Due Date</label>
                <input id="t_due" type="date" />
              </div>
              <div>
                <label>Status</label>
                <select id="t_status">
                  <option>Not Started</option>
                  <option>In Progress</option>
                  <option>Blocked</option>
                  <option>Done</option>
                </select>
              </div>
            </div>
            <div>
              <label>Notes / Links</label>
              <textarea id="t_notes" placeholder="Blockers, assumptions, file paths, SharePoint links, etc."></textarea>
            </div>
          </div>
          <div class="footer-note">
            Pro move: keep tasks atomic (1 deliverable + 1 site + 1 chunk of rooms). It makes status reporting painless.
          </div>
        </div>
      </div>
    </div>
  </div>

  <input id="importFile" type="file" accept="application/json" style="display:none" />

</main>

<script>
(() => {
  const LS_KEY = "plm_ecr0007_tfr_tracker_v1";
  const DEFAULT_DATA = {"version": 1, "people": ["Chad Polivka", "David Kelley", "Geoffrey Terry", "James Cochran", "Justin Forester", "Keith Stewart", "Weston Bragg"], "sites": [{"id": "lemoore", "name": "NAS Lemoore, CA", "cdrl": "TFR A001", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "miramar", "name": "MCAS Miramar, San Diego, CA", "cdrl": "TFR A002", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "coronado", "name": "Naval Base Coronado (North Island), San Diego, CA", "cdrl": "TFR A003", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "jax", "name": "NAS Jacksonville, FL", "cdrl": "TFR A004", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "pcola_nattc", "name": "NAS Pensacola, FL (NATTC)", "cdrl": "TFR A005", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "pcola_naccs", "name": "NAS Pensacola, FL (NACCS)", "cdrl": "TFR A006", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "panama", "name": "NSA Panama City, FL", "cdrl": "TFR A007", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "greatlakes", "name": "Naval Station Great Lakes, IL", "cdrl": "TFR A008", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "gulfport", "name": "NCBC Gulfport, MS", "cdrl": "TFR A009", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "keesler", "name": "Keesler AFB, Biloxi, MS", "cdrl": "TFR A010", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "tinker", "name": "Tinker AFB, Oklahoma City, OK", "cdrl": "TFR A011", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "oceana", "name": "NAS Oceana, Virginia Beach, VA", "cdrl": "TFR A012", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "norfolk", "name": "Naval Station Norfolk, VA", "cdrl": "TFR A013", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}, {"id": "whidbey", "name": "NAS Whidbey Island, Oak Harbor, WA", "cdrl": "TFR A014", "meta": {"rooms_total": null, "due_date": null, "notes": ""}, "deliverables": {"existing_drawings": "Not Started", "planned_drawings": "Not Started", "tfr_narrative": "Not Started", "qc_review": "Not Started", "submitted": "Not Started"}}], "tasks": []};

  const tabs = [
    { id:"master", label:"Master" },
    { id:"tasks", label:"Tasks" },
    { id:"settings", label:"Settings" },
  ];

  const statusOrder = ["Not Started","In Progress","Blocked","Done"];

  const el = (id) => document.getElementById(id);
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const chip = (status) => {
    const s = (status||"Not Started").trim();
    const cls = (s==="Done") ? "ok" : (s==="Blocked") ? "bad" : (s==="In Progress") ? "warn" : "neutral";
    return `<span class="chip ${cls}">${escapeHtml(s)}</span>`;
  };

  const escapeHtml = (str="") => str
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const uid = () => "t_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

  const load = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return structuredClone(DEFAULT_DATA);
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") return structuredClone(DEFAULT_DATA);
      // basic migration safety
      if (!data.version) data.version = 1;
      if (!Array.isArray(data.people)) data.people = structuredClone(DEFAULT_DATA.people);
      if (!Array.isArray(data.sites)) data.sites = structuredClone(DEFAULT_DATA.sites);
      if (!Array.isArray(data.tasks)) data.tasks = [];
      return data;
    } catch {
      return structuredClone(DEFAULT_DATA);
    }
  };

  const save = () => {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  };

  const toDate = (d) => d ? new Date(d + "T00:00:00") : null;
  const daysUntil = (d) => {
    const dd = toDate(d);
    if (!dd) return null;
    const now = new Date(); now.setHours(0,0,0,0);
    return Math.round((dd - now) / (1000*60*60*24));
  };

  const siteById = (id) => state.sites.find(s => s.id === id);

  const recompute = () => {
    // KPIs
    el("teamCount").textContent = state.people.length;
    el("kpiSites").textContent = state.sites.length;

    const open = state.tasks.filter(t => t.status !== "Done");
    el("kpiTasksOpen").textContent = open.length;

    const dueSoon = open.filter(t => {
      const du = daysUntil(t.due_date);
      return du !== null && du <= 7 && du >= 0;
    });
    el("kpiDueSoon").textContent = dueSoon.length;
  };

  const renderTabs = () => {
    const host = el("tabs");
    host.innerHTML = tabs.map(t => `<div class="tab" data-tab="${t.id}">${t.label}</div>`).join("");
    host.addEventListener("click", (e) => {
      const tab = e.target.closest(".tab");
      if (!tab) return;
      const id = tab.dataset.tab;
      showView(id);
    });
  };

  const showView = (id) => {
    $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === id));
    $$(".view").forEach(v => v.style.display = "none");
    if (id === "master") el("view_master").style.display = "";
    if (id === "tasks") el("view_tasks").style.display = "";
    if (id === "settings") el("view_settings").style.display = "";
    // keep site view separate
    renderAll();
  };

  const deliverableKeys = ["existing_drawings", "planned_drawings", "tfr_narrative", "qc_review", "submitted"];
  const deliverableLabels = {
    "existing_drawings":"Drawings – Existing",
    "planned_drawings":"Drawings – Planned",
    "tfr_narrative":"TFR Narrative / Analysis",
    "qc_review":"QC / Internal Review",
    "submitted":"Submitted",
  };

  const scoreStatus = (s) => {
    if (s === "Done") return 1;
    if (s === "In Progress") return 0.5;
    return 0;
  };

  const siteOverallPct = (siteId) => {
    const site = siteById(siteId);
    if (!site) return 0;
    const delivs = deliverableKeys.map(k => site.deliverables?.[k] || "Not Started");
    const dScore = delivs.reduce((a,s) => a + scoreStatus(s), 0) / deliverableKeys.length;

    const tasks = state.tasks.filter(t => t.site_id === siteId);
    const tScore = tasks.length ? (tasks.filter(t => t.status==="Done").length / tasks.length) : 0;

    // weighted: deliverables 60%, tasks 40% (tweak as needed)
    return Math.round((dScore*0.6 + tScore*0.4) * 100);
  };

  const renderSitesTable = () => {
    const tb = $("#sitesTable tbody");
    tb.innerHTML = state.sites.map(s => {
      const pct = siteOverallPct(s.id);
      const dchips = deliverableKeys.map(k => {
        const st = s.deliverables?.[k] || "Not Started";
        return `<div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:4px 0">
                  <span class="muted" style="font-size:12px">${deliverableLabels[k]}</span>
                  ${chip(st)}
                </div>`;
      }).join("");

      return `<tr data-site="${s.id}" style="cursor:pointer">
        <td><div style="font-weight:650">${escapeHtml(s.name)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(s.meta?.notes ? s.meta.notes.slice(0,56) + (s.meta.notes.length>56?"…":"") : "")}</div>
        </td>
        <td class="mono">${escapeHtml(s.cdrl || "")}</td>
        <td>${dchips}</td>
        <td>
          <div class="progress" title="${pct}%"><div style="width:${pct}%"></div></div>
          <div class="muted" style="font-size:12px; margin-top:6px">${pct}%</div>
        </td>
      </tr>`;
    }).join("");

    tb.onclick = (e) => {
      const tr = e.target.closest("tr[data-site]");
      if (!tr) return;
      openSite(tr.dataset.site);
    };
  };

  const renderOwnerFilters = () => {
    const peopleOpts = ["(All)", ...state.people].map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    el("filterOwner").innerHTML = peopleOpts;
    el("taskOwnerFilter").innerHTML = peopleOpts;

    const siteOpts = ['<option value="(All)">(All)</option>', ...state.sites.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`)].join("");
    el("taskSiteFilter").innerHTML = siteOpts;

    const taskSiteOpts = state.sites.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
    el("t_site").innerHTML = taskSiteOpts;

    const ownerOpts = state.people.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
    el("t_owner").innerHTML = ownerOpts;
  };

  const renderQueue = () => {
    const owner = el("filterOwner").value || "(All)";
    const st = el("filterStatus").value;

    const rows = state.tasks
      .filter(t => owner === "(All)" ? true : t.owner === owner)
      .filter(t => {
        if (st === "__all__") return true;
        if (st === "__open__") return t.status !== "Done";
        return t.status === st;
      })
      .sort((a,b) => (a.due_date||"").localeCompare(b.due_date||""))
      .slice(0, 30);

    $("#queueTable tbody").innerHTML = rows.map(t => {
      const site = siteById(t.site_id);
      const siteLabel = site ? site.name : "(Unknown site)";
      const due = t.due_date ? t.due_date : "";
      return `<tr>
        <td>
          <div style="font-weight:650">${escapeHtml(t.name)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(siteLabel)}${t.room ? " • " + escapeHtml(t.room) : ""}</div>
        </td>
        <td>${escapeHtml(t.owner || "")}</td>
        <td class="mono">${escapeHtml(due)}</td>
        <td>${chip(t.status)}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="4" class="muted">No matching tasks. Either you’re crushing it… or nobody logged their work.</td></tr>`;
  };

  // Site view
  let currentSiteId = null;

  const openSite = (siteId) => {
    currentSiteId = siteId;
    el("view_master").style.display = "none";
    el("view_tasks").style.display = "none";
    el("view_settings").style.display = "none";
    el("view_site").style.display = "";
    $$(".tab").forEach(t => t.classList.remove("active"));
    renderSite();
  };

  const renderSite = () => {
    const s = siteById(currentSiteId);
    if (!s) return;

    el("siteTitle").textContent = s.name;
    el("siteHint").textContent = `Full details • ${s.cdrl}`;
    el("siteCdrl").value = s.cdrl || "";
    el("siteRooms").value = s.meta?.rooms_total ?? "";
    el("siteDue").value = s.meta?.due_date ?? "";
    el("siteNotes").value = s.meta?.notes ?? "";

    const grid = el("deliverableGrid");
    grid.innerHTML = deliverableKeys.map(k => {
      const st = s.deliverables?.[k] || "Not Started";
      return `<div class="row2" style="align-items:center">
        <div class="muted" style="font-size:12px">${deliverableLabels[k]}</div>
        <select data-deliv="${k}">
          <option${st==="Not Started"?" selected":""}>Not Started</option>
          <option${st==="In Progress"?" selected":""}>In Progress</option>
          <option${st==="Blocked"?" selected":""}>Blocked</option>
          <option${st==="Done"?" selected":""}>Done</option>
        </select>
      </div>`;
    }).join("");

    grid.onchange = (e) => {
      const sel = e.target.closest("select[data-deliv]");
      if (!sel) return;
      const k = sel.dataset.deliv;
      s.deliverables[k] = sel.value;
      save(); renderAll();
    };

    el("siteRooms").onchange = () => {
      s.meta.rooms_total = el("siteRooms").value ? Number(el("siteRooms").value) : null;
      save(); renderAll();
    };
    el("siteDue").onchange = () => {
      s.meta.due_date = el("siteDue").value || null;
      save(); renderAll();
    };
    el("siteNotes").onchange = () => {
      s.meta.notes = el("siteNotes").value || "";
      save(); renderAll();
    };

    const rows = state.tasks
      .filter(t => t.site_id === currentSiteId)
      .sort((a,b) => (a.due_date||"").localeCompare(b.due_date||""));

    $("#siteTasksTable tbody").innerHTML = rows.map(t => `
      <tr>
        <td>
          <div style="font-weight:650">${escapeHtml(t.name)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(t.notes || "").slice(0,72)}${(t.notes||"").length>72?"…":""}</div>
        </td>
        <td>${escapeHtml(t.owner||"")}</td>
        <td class="muted">${escapeHtml(t.type||"")}</td>
        <td class="mono">${escapeHtml(t.room||"")}</td>
        <td class="mono">${escapeHtml(t.due_date||"")}</td>
        <td>${chip(t.status)}</td>
        <td style="text-align:right">
          <button data-edit="${t.id}">Edit</button>
          <button class="danger" data-del="${t.id}">Del</button>
        </td>
      </tr>
    `).join("") || `<tr><td colspan="7" class="muted">No tasks have been added for this site.</td></tr>`;

    $("#siteTasksTable tbody").onclick = (e) => {
      const ed = e.target.closest("button[data-edit]");
      const del = e.target.closest("button[data-del]");
      if (ed) openTaskModal(ed.dataset.edit);
      if (del) {
        const id = del.dataset.del;
        state.tasks = state.tasks.filter(t => t.id !== id);
        save(); renderAll();
      }
    };
  };

  const renderTasksTable = () => {
    const q = (el("taskSearch").value || "").toLowerCase().trim();
    const owner = el("taskOwnerFilter").value || "(All)";
    const siteFilter = el("taskSiteFilter").value || "(All)";

    let rows = state.tasks.slice();
    if (q) rows = rows.filter(t => (t.name||"").toLowerCase().includes(q) || (t.notes||"").toLowerCase().includes(q) || (t.room||"").toLowerCase().includes(q));
    if (owner !== "(All)") rows = rows.filter(t => t.owner === owner);
    if (siteFilter !== "(All)") rows = rows.filter(t => t.site_id === siteFilter);

    rows.sort((a,b) => (a.due_date||"").localeCompare(b.due_date||""));

    $("#tasksTable tbody").innerHTML = rows.map(t => {
      const site = siteById(t.site_id);
      return `<tr>
        <td>
          <div style="font-weight:650">${escapeHtml(t.name)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(t.notes || "").slice(0,64)}${(t.notes||"").length>64?"…":""}</div>
        </td>
        <td>${escapeHtml(site ? site.name : "")}</td>
        <td>${escapeHtml(t.owner||"")}</td>
        <td class="muted">${escapeHtml(t.type||"")}</td>
        <td class="mono">${escapeHtml(t.room||"")}</td>
        <td class="mono">${escapeHtml(t.due_date||"")}</td>
        <td>${chip(t.status)}</td>
        <td style="text-align:right">
          <button data-edit="${t.id}">Edit</button>
          <button class="danger" data-del="${t.id}">Del</button>
        </td>
      </tr>`;
    }).join("") || `<tr><td colspan="8" class="muted">No tasks found.</td></tr>`;

    $("#tasksTable tbody").onclick = (e) => {
      const ed = e.target.closest("button[data-edit]");
      const del = e.target.closest("button[data-del]");
      if (ed) openTaskModal(ed.dataset.edit);
      if (del) {
        const id = del.dataset.del;
        state.tasks = state.tasks.filter(t => t.id !== id);
        save(); renderAll();
      }
    };
  };

  // Modal logic
  let editingTaskId = null;

  const openTaskModal = (taskId=null, presetSiteId=null) => {
    editingTaskId = taskId;
    const isEdit = !!taskId;
    el("modalTitle").textContent = isEdit ? "Edit Task" : "New Task";
    el("modal").style.display = "";

    const t = isEdit ? state.tasks.find(x => x.id === taskId) : {
      id: uid(),
      name: "",
      site_id: presetSiteId || state.sites[0].id,
      owner: state.people[0] || "",
      type: "Drawings – Existing",
      room: "",
      due_date: "",
      status: "Not Started",
      notes: ""
    };

    el("t_name").value = t.name || "";
    el("t_site").value = t.site_id || state.sites[0].id;
    el("t_owner").value = t.owner || (state.people[0] || "");
    el("t_type").value = t.type || "Drawings – Existing";
    el("t_room").value = t.room || "";
    el("t_due").value = t.due_date || "";
    el("t_status").value = t.status || "Not Started";
    el("t_notes").value = t.notes || "";

    // If new task, keep id in closure by attaching to modal
    el("modal").dataset.tempid = t.id;
  };

  const closeModal = () => {
    el("modal").style.display = "none";
    editingTaskId = null;
  };

  el("btnClose").onclick = closeModal;
  el("modal").onclick = (e) => {
    if (e.target === el("modal")) closeModal();
  };

  el("btnSave").onclick = () => {
    const id = editingTaskId || el("modal").dataset.tempid || uid();
    const obj = {
      id,
      name: el("t_name").value.trim() || "(Untitled task)",
      site_id: el("t_site").value,
      owner: el("t_owner").value,
      type: el("t_type").value,
      room: el("t_room").value.trim(),
      due_date: el("t_due").value,
      status: el("t_status").value,
      notes: el("t_notes").value.trim()
    };

    const idx = state.tasks.findIndex(t => t.id === id);
    if (idx >= 0) state.tasks[idx] = obj;
    else state.tasks.push(obj);

    save();
    closeModal();
    renderAll();
  };

  // Buttons wiring
  el("btnNewTask").onclick = () => openTaskModal(null);
  el("btnNewTask2").onclick = () => openTaskModal(null);
  el("btnAddSiteTask").onclick = () => openTaskModal(null, currentSiteId);

  el("btnBack").onclick = () => {
    el("view_site").style.display = "none";
    showView("master");
  };

  el("btnNukeDone").onclick = () => {
    if (!confirm("Delete ALL tasks marked Done?")) return;
    state.tasks = state.tasks.filter(t => t.status !== "Done");
    save(); renderAll();
  };

  // Export / Import
  const download = (filename, text) => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  };

  el("btnExport").onclick = () => {
    const stamp = new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_");
    download(`plm_ecr0007_tracker_${stamp}.json`, JSON.stringify(state, null, 2));
  };

  el("btnImport").onclick = () => el("importFile").click();
  el("importFile").onchange = async () => {
    const f = el("importFile").files?.[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const data = JSON.parse(txt);
      if (!data || typeof data !== "object") throw new Error("Bad JSON");
      if (!Array.isArray(data.sites) || !Array.isArray(data.people) || !Array.isArray(data.tasks)) throw new Error("Missing keys");
      state = data;
      save();
      renderAll();
      alert("Imported ✔");
    } catch (err) {
      alert("Import failed: " + err.message);
    } finally {
      el("importFile").value = "";
    }
  };

  // Settings view
  el("lsKey").textContent = LS_KEY;
  el("btnSavePeople").onclick = () => {
    const lines = el("peopleBox").value.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    if (!lines.length) return alert("Add at least one person.");
    state.people = Array.from(new Set(lines));
    // normalize existing tasks owners if needed (keep as-is)
    save();
    renderAll();
    alert("Saved ✔");
  };

  el("btnReset").onclick = () => {
    if (!confirm("Reset EVERYTHING back to defaults?")) return;
    state = structuredClone(DEFAULT_DATA);
    save(); renderAll();
  };

  // Task filter handlers
  ["filterOwner","filterStatus","taskSearch","taskOwnerFilter","taskSiteFilter"].forEach(id => {
    el(id).addEventListener("input", () => renderAll());
    el(id).addEventListener("change", () => renderAll());
  });

  const renderSettings = () => {
    el("peopleBox").value = state.people.join("\n");
  };

  const renderAll = () => {
    recompute();
    renderOwnerFilters();
    renderSitesTable();
    renderQueue();
    renderTasksTable();
    renderSettings();
    if (el("view_site").style.display !== "none" && currentSiteId) renderSite();
  };

  // init
  let state = load();
  renderTabs();
  showView("master");
  renderAll();

})();
</script>
</body>
</html>
